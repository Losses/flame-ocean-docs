# 内存布局图

**状态**: ✅ 已确认
**最后更新**: 2026-01-28

---

## 固件内存布局

### 整体结构

```
0x000000 ┌────────────────────────────────────┐
          │  Boot Header (SDK 信息)            │
0x000460 ├────────────────────────────────────┤
          │  Vector Table (中断向量表)          │
0x0004A0 ├────────────────────────────────────┤
          │  .text / .data (代码与数据)         │
          │  - 渲染代码: 0x2DA00-0x2DB60       │
0x100000 ├────────────────────────────────────┤
          │  Font Data Base (字体数据基址)      │
          │  - 字符数据: 0x100000 + r5 × 4     │
0x14AD6  ├────────────────────────────────────┤
          │  Offset Table (偏移表)              │
0x1C000  ├────────────────────────────────────┤
          │  Symbol Table Base (符号表基址)     │
          │  - 符号表: 0x1C000 + r5 × 8        │
0x778000 ├────────────────────────────────────┤
          │  Language Table (语言表)            │
          │  - UTF-16 BE 字符串                │
0x779000 └────────────────────────────────────┘
          │  ... (其他数据)                     │
0x2000000└────────────────────────────────────┘
```

---

## 关键地址汇总

| 地址 | 内容 | 大小 |
|------|------|------|
| 0x0000 | Stack Pointer | - |
| 0x0004 | Reset Vector | - |
| 0x0010 | "Rockchip" 字符串 | 8 bytes |
| 0x0030 | "RKnano S1.30" | 12 bytes |
| 0x12EC | Entry Point 验证 | - |
| 0x2D3C6 | 渲染函数入口 | - |
| 0x2DA88 | 内联渲染代码 | - |
| 0x2DB12 | 编码类型判定 | - |
| 0x2DB58 | 像素数据加载 | - |
| 0x2DC22 | 死代码路径 | - |
| 0x14AD6 | 偏移表 | - |
| 0x778000 | 语言表 | ~8KB |

### 语言表详细信息 (0x778000)

**编码**: UTF-16 BE (Big Endian)

| 字符串 | 位置 | UTF-16 BE 字节 |
|--------|------|---------------|
| 日本語 | 0x778666 | 65 E5 67 2C 8A 9E |
| 繁體中文 | 0x778462 | 7E 41 9A D4 4E 2D 65 87 |

**索引结构**:
```
0x77862C: 01 5E  (日本語索引 = 94)
0x77862E: 01 5A  (相关索引 = 90)
```

**完整布局**:
```
0x778620-0x778670: 语言索引和参数
0x778660+:         实际 UTF-16 字符串数据
```

详见: **[语言表发现](./LANGUAGE_TABLE.md)**

---

## 字符数据内存布局

### 单个字符结构

```
@ r6 = 0x100000 + r5 × 4:
  +0x00:  metadata[0]     (编码类型: 高4位)
  +0x01:  metadata[1]     (像素数据的一部分)
  +0x02:  metadata[2]     (未知)
  +0x03:  metadata[3]     (像素数据的一部分)
  +0x04:  metadata[4]     (未知)
  +0x05:  metadata[5]     (未知)
  +0x06:  row_data[0]     (16 位值)
  +0x08:  row_data[1]     (16 位值)
  ...
  +0x38:  row_data[15]    (16 位值)
```

### 示例: 沨字 (r5=0x0FDE)

```
地址: 0x103F78 = 0x100000 + 0x0FDE × 4

+0x00:  39 96 40 88 47 70  (metadata[0-5])
+0x06:  39 96 40 88 47 70 ... (row_data[0-15], little-endian)
```

---

## 渲染上下文内存布局

```
@ r1 (渲染上下文指针):
  +0x00:  field_0x00     (r3)
  +0x04:  field_0x04     (r4 = metadata[0] >> 4)
  +0x08:  char_index     (r5 = 字符索引)
  +0x0C:  font_data_ptr  (r6 = 0x100000 + r5 × 4)
  +0x10:  field_0x10     (r7)
```

---

**参见**:
- [数据结构定义](./DATA_STRUCTURES.md)
- [像素数据位置](../04_DATA_DISCOVERY/PIXEL_DATA_LOCATION.md)
