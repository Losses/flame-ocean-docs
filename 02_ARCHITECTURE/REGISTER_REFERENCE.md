# 寄存器参考

**状态**: ✅ 汇总完成
**最后更新**: 2026-01-29

---

## 快速参考表

| 寄存器 | 用途 | 详细文档 |
|--------|------|----------|
| **r0** | 临时寄存器，用于 bit 7 测试、数据加载 | [R0 Bit 7 测试](../03_CODE_ANALYSIS/REGISTERS/R0_BIT7_TEST.md) |
| **r1** | 渲染上下文指针 | [数据结构定义](./DATA_STRUCTURES.md) |
| **r2** | 函数参数，用于 bit 7 测试 | [R2 参数](../03_CODE_ANALYSIS/REGISTERS/R2_PARAMETER.md) |
| **r3** | 行索引或偏移量 | [R3 行索引](../03_CODE_ANALYSIS/REGISTERS/R3_ROW_INDEX.md) |
| **r4** | 首字节高4位 / 符号表指针 | [R4 符号表](../03_CODE_ANALYSIS/REGISTERS/R4_SYMBOL_TABLE.md) |
| **r5** | Unicode → 内部索引映射 | [Unicode查找表](../04_DATA_DISCOVERY/UNICODE_TO_R5_MAPPING.md) |
| **r6** | 字体数据指针 @ 0x100000 + r5 × 4 | [像素数据位置](../04_DATA_DISCOVERY/PIXEL_DATA_LOCATION.md) |
| **r7** | 渲染上下文 / 基址指针 | [数据结构定义](./DATA_STRUCTURES.md) |

---

## 详细说明

### r0 - 临时寄存器

**用途**: 各种临时计算和数据加载

**关键用途**:
1. **Bit 7 测试** - `cmp r0, #0x80` 判定编码类型
2. **像素数据加载** - `ldrh r0, [r7, r3]`
3. **符号扩展加载** - `ldrsb r0, [r7, r3]`

**相关文档**: [指令级追踪](../03_CODE_ANALYSIS/INSTRUCTION_TRACE.md)

---

### r1 - 渲染上下文指针

**用途**: 指向渲染上下文结构

**关键用途**:
1. `ldm r1!, {r3-r7}` - 加载渲染上下文
2. 偏移量/列索引

**相关文档**: [数据结构定义](./DATA_STRUCTURES.md)

---

### r2 - 函数参数

**用途**: 函数参数，用于 bit 7 测试

**关键用途**:
1. `movs r2, r0` - 保存 r0 值用于 bit 7 测试
2. `cmp r2, #0x80` - 判定编码类型

**相关文档**: [指令级追踪](../03_CODE_ANALYSIS/INSTRUCTION_TRACE.md)

---

### r3 - 行索引或偏移量

**用途**: 行索引或偏移量

**关键用途**:
1. `lsls r3, r3, #0x10` - 16 位移位 (行计数)
2. `ldrh r0, [r7, r3]` - 加载像素数据

**相关文档**: [指令级追踪](../03_CODE_ANALYSIS/INSTRUCTION_TRACE.md)

---

### r4 - 高4位值 / 符号表指针

**用途**: 首字节高4位，用于编码判定和符号表计算

**关键用途**:
1. `movs r4, r5` - 复制 r5 到 r4
2. `lsls r4, r5, #5` - 符号表指针计算 (r5 × 32)
3. `lsls r0, r4, #4` - 准备编码测试

**相关文档**: [内联渲染逻辑](../03_CODE_ANALYSIS/INLINE_RENDERING.md)

---

### r5 - Unicode → 内部索引

**用途**: Unicode 到内部索引的映射结果

**关键用途**:
1. 编码类型判定 (`metadata[0] >> 4`)
2. 符号表索引计算 (`r5 << 5`)
3. Unicode 映射公式: `r5 = Unicode - 0x5CCA + sub_offset`

**映射示例**:
```
U+6CA8 (沨) → r5 = 0x0FDE
U+6CA5 (沦) → r5 = 0x0FDC
U+6CAA (沪) → r5 = 0x0FDA
```

**相关文档**: [Unicode查找表](../04_DATA_DISCOVERY/UNICODE_TO_R5_MAPPING.md)

---

### r6 - 字体数据指针

**用途**: 指向字符的像素数据

**计算公式**:
```
r6 = 0x100000 + r5 × 4
```

**数据结构**:
```c
struct character_data {
    uint8_t metadata[6];     // 偏移 +0 - +5
    uint16_t row_data[16];   // 偏移 +6 - +37 (像素数据从 +6 开始)
};
```

**相关文档**: [像素数据位置](../04_DATA_DISCOVERY/PIXEL_DATA_LOCATION.md)

---

### r7 - 渲染上下文 / 基址指针

**用途**: 基址指针，指向像素数据或渲染上下文

**关键用途**:
1. `ldrh r0, [r7, r3]` - 从 r7 加载 r3 偏移处的像素数据
2. `strh r3, [r7, #0xe]` - 存储处理后的像素行
3. `revsh r1, r6` - 字节交换 (特殊编码)

**相关文档**:
- [数据结构定义](./DATA_STRUCTURES.md)
- [0x13365E 函数分析](../03_CODE_ANALYSIS/FUNCTION_0x13365E.md)

---

## 寄存器生命周期追踪 (0x13365E 函数)

```
1. ldrh r0, [r7, r3]    - 从基址 r7 加载 r3 偏移处的像素数据
2. lsls r1, r5, #0x10  - 准备行处理 (16 位)
3. lsrs r0, r3, #2      - 右移 2 位 (可能是除以 4)
4. strh r3, [r7, #0xe]  - 存储处理后的像素行
5. lsls r1, r6, #8      - 字节级移位 (8 位)
```

**输入寄存器** (0x13365E 函数):
- r7: 基址指针（指向像素数据或渲染上下文）
- r3: 行索引或偏移
- r5: 参数（可能是行计数 = 16）

---

## 寄存器生命周期追踪

```
┌─────────────────────────────────────────────────────────────┐
│ 阶段 1: Unicode → r5 映射                                    │
├─────────────────────────────────────────────────────────────┤
│ 输入: Unicode (r0/r6)                                        │
│ 输出: r5 = Unicode - 偏移量                                  │
│ 位置: 映射函数 (具体地址未知)                                 │
└─────────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────────┐
│ 阶段 2: 渲染上下文加载 (0x2DA8E)                             │
├─────────────────────────────────────────────────────────────┤
│ ldm r1!, {r3, r4, r5, r6, r7}                               │
│ r3, r4, r5, r6, r7 从 r1 加载                               │
└─────────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────────┐
│ 阶段 3: 编码判定 (0x2DB12)                                   │
├─────────────────────────────────────────────────────────────┤
│ r4 = r5                                                      │
│ r0 = r4 << 4                                                │
│ cmp r0, #0x80  (测试 bit 7)                                  │
└─────────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────────┐
│ 阶段 4: 像素数据加载 (0x2DB58)                               │
├─────────────────────────────────────────────────────────────┤
│ r6 = 0x100000 + r5 × 4                                      │
│ ldrh r2, [r6, #6]  (从 r6+6 加载像素数据)                    │
└─────────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────────┐
│ 阶段 5: 显示缓冲区存储 (0x2DB60)                              │
├─────────────────────────────────────────────────────────────┤
│ strh r6, [r0, r1]  (存储到显示缓冲区)                        │
└─────────────────────────────────────────────────────────────┘
```

---

## 文档状态

| 寄存器 | 状态 | 文档 |
|--------|------|------|
| r0 | ✅ 完成 | [R0 Bit 7 测试](../03_CODE_ANALYSIS/REGISTERS/R0_BIT7_TEST.md) |
| r1 | ✅ 完成 | [数据结构定义](./DATA_STRUCTURES.md) |
| r2 | ✅ 完成 | [R2 参数](../03_CODE_ANALYSIS/REGISTERS/R2_PARAMETER.md) |
| r3 | ✅ 完成 | [R3 行索引](../03_CODE_ANALYSIS/REGISTERS/R3_ROW_INDEX.md) |
| r4 | ✅ 完成 | [R4 符号表](../03_CODE_ANALYSIS/REGISTERS/R4_SYMBOL_TABLE.md) |
| r5 | ✅ 完成 | [Unicode查找表](../04_DATA_DISCOVERY/UNICODE_TO_R5_MAPPING.md) |
| r6 | ✅ 完成 | [像素数据位置](../04_DATA_DISCOVERY/PIXEL_DATA_LOCATION.md) |
| r7 | ✅ 完成 | [数据结构定义](./DATA_STRUCTURES.md) |

---

## 渲染管线总结

基于已验证的指令，渲染流程如下：

```
1. ldrh r0, [r7, r3]    - 从基址 r7 加载 r3 偏移处的像素数据
2. lsls r1, r5, #0x10  - 准备行处理 (16 位)
3. lsrs r0, r3, #2      - 右移 2 位 (可能是除以 4)
4. strh r3, [r7, #0xe]  - 存储处理后的像素行
5. lsls r1, r6, #8      - 字节级移位 (8 位)
```

---

**参见**:
- [指令级追踪](../03_CODE_ANALYSIS/INSTRUCTION_TRACE.md)
- [内联渲染逻辑](../03_CODE_ANALYSIS/INLINE_RENDERING.md)
