# Unicode 查找表

**状态**: ✅ 已确认
**最后更新**: 2026-01-28

---

## Unicode 到 r5 映射机制

### 映射公式

```python
def unicode_to_r5(unicode):
    u_hi = unicode >> 8
    u_lo = unicode & 0xFF

    # 高字节: 简单减法
    r5_hi = u_hi - 0x5D

    # 低字节: 通过 offset 函数
    offset_val = offset(u_lo)
    r5_lo = u_lo + offset_val

    return (r5_hi << 8) | r5_lo

def offset(u_lo):
    """计算 Unicode 低字节到 r5 低字节的偏移量"""
    idx = u_lo - 0xA0
    adj_table = [0x0C, 0x0C, 0x0A, 0x00]
    adj_idx = (idx - 4) // 2
    adj = adj_table[adj_idx]
    return 0x32 + (((10 - idx) ^ adj) >> 1)
```

---

## 映射验证

### 验证结果 (100% 通过)

| Unicode | 字符 | r5 计算 | r5 期望 | 匹配 |
|---------|------|---------|---------|------|
| 0x6CA8  | 沨   | 0x0FDE  | 0x0FDE  | ✅    |
| 0x6CA4  | 沤   | 0x0FDB  | 0x0FDB  | ✅    |
| 0x6CA6  | 沦   | 0x0FDC  | 0x0FDC  | ✅    |
| 0x6CAA  | 沪   | 0x0FDA  | 0x0FDA  | ✅    |

---

## 偏移表结构

### 位置和格式

```
偏移表 @ 0x14AD6:
  - 格式: 16 位值数组，小端序存储
  - 索引公式: (Unicode 低位 & 0x0F) - 2
  - 适用于 U+6CAx 范围的字符
```

### 已知偏移量

| Unicode 低位 | 索引 | 偏移量 (LE) | 偏移量 | 字符 |
|--------------|------|-------------|--------|------|
| 0xA4 | 2 | 0xC95C | 0x5CC9 | 沤 |
| 0xA6 | 4 | 0xCA5C | 0x5CCA | 沦 |
| 0xA8 | 4 | 0xCA5C | 0x5CCA | 沨 |
| 0xAA | ? | ? | 0x5CD0 | 沪 (不在表中) |

---

## 两套字符表

### 沪字 (U+6CAA) 的两个版本

| r5 值 | 编码类型 | 元数据[0] | 位图特征 |
|-------|---------|-----------|----------|
| 0x0FDA | 标准 (15列) | 0x20 | ......@@@@.@@@.. |
| 0x3235 | 特殊 (14列) | 0xEB | .@....@@@@@@@... |

**结论**: 固件中存在**两套字符表**或**字符的两个版本**。

---

## 数据流

```
Unicode (U+6CA8 沨)
    │
    ├─ 高字节 0x6C → r5_hi = 0x6C - 0x5D = 0x0F
    │
    └─ 低字节 0xA8 → offset = 0x36 → r5_lo = 0xA8 + 0x36 = 0xDE
    │
    ▼
r5 = 0x0FDE → 渲染上下文 → 符号表 → 像素渲染
```

---

## 渲染上下文设置

```assembly
; 渲染函数入口 (0x2DA8E)
0x0002DA8E:  ldm    r1!, {r3, r4, r5, r6, r7}  ; r5 = [r1 + 8]
```

**r5 的完整生命周期**:
```
1. Unicode 输入 → 映射函数 → r5 = 0x0FDE
2. r5 存储到渲染上下文 [ctx + 8]
3. 渲染时从上下文加载 r5
4. r5 计算符号表地址: r4 = r5 << 5
5. 符号表用于像素渲染
```

---

## Unicode 表分布

### 主要 Unicode 表汇总

| 表地址 | 字符数量 | 用户数据中的字符 |
|--------|----------|------------------|
| 0x004E00 | ~100 | 沚, 沁, 沛, 汾, 沨, 汨, 沒, 沐, 泄, 沽, 泗, 泅, 泝, 沮, 沱, 沾, 沺, 泛, 泯, 泙, 泪, 洟, 衍 |
| 0x0FDE0 | 140 | 汰, 汲, 汶, 汾, 沄, 沂, 決, 汸, 沆, 沈, 沌, 沘 |
| 0x04DE0 | ~80 | 沚, 沁, 沛, 汾, 沨, 汨, 沒, 沐, 泄, 泣, 況, 泓, 沽, 泗, 泅, 泝, 沮, 沱, 沾, 沺, 泛, 泯, 泙, 泪, 洟, 衍 |
| 0x147E0 | ~50 | 汃, 汸, 沚, 沜, 沴, 氵 |
| 0x101E0 | ~90 | 泄, 沬, 泊, 沮 |
| 0x143E0 | ~60 | 沄, 汸, 沚, 沜 |
| 0x00FE30 | ~50 | 汰, 汲 |
| 0x031E0 | ~150 | 汰, 汶, 沢 |

### 表 0x0FDE0 分析

表 0x0FDE0 是**最大的字符表**，包含 140 个 CJK 字符：

| 索引 | 字符 | Unicode | 偏移 |
|------|------|---------|------|
| 34 | 沈 | U+6C88 | 0x466352 |
| 39 | 決 | U+6C7A | 0x466184 |
| 41 | 汰 | U+6C70 | 0x46603A |
| 42 | 沌 | U+6C8C | 0x4663D6 |
| 48 | 汲 | U+6C72 | 0x46607C |
| 49 | 汾 | U+6C7E | 0x466208 |
| 51 | 沆 | U+6C86 | 0x466310 |
| 52 | 汶 | U+6C76 | 0x466100 |
| 55 | 沘 | U+6C98 | 0x466562 |
| 56 | 沂 | U+6C82 | 0x46628C |

### 表 0x004E00 分段线性

表 0x004E00 索引 22-27 遵循线性公式：

```
offset = 462 × (index - 22) + 520
```

| 索引 | 字符 | Unicode | 预测偏移 | 实际偏移 | 状态 |
|------|------|---------|----------|----------|------|
| 22 | 汾 | U+6C7E | 520 | 520 | ✓ |
| 23 | ? | - | 982 | - | 空 |
| 24 | ? | - | 1444 | - | 空 |
| 25 | ? | - | 1906 | - | 空 |
| 26 | ? | - | 2368 | - | 空 |
| 27 | 泄 | U+6CC4 | 2830 | 2830 | ✓ |

---

## 字符共享偏移

### 共享偏移案例

| 偏移 | 字符 1 | Unicode 1 | 字符 2 | Unicode 2 |
|------|--------|-----------|--------|-----------|
| 0x4663D6 | 沌 | U+6C8C | 沢 | U+6CA2 |

**沌 (U+6C8C)** 和 **沢 (U+6CA2)** 使用同一个字体数据偏移！

---

**参见**:
- [像素数据位置](./PIXEL_DATA_LOCATION.md)
- [编码规则](./ENCODING_RULES.md)
- [调试用字符表](./DEBUG_CHARACTER_TABLE.md)
