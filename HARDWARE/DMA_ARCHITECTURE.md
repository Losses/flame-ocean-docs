# DMA 架构分析

**芯片**: Rockchip RKnano
**分析来源**: RKNanoD TRM Chapter 8 + 固件代码分析
**状态**: 部分确认

---

## DMAC 控制器概述

### 硬件配置

| 控制器 | 基地址 | 通道数 | 电源域 |
|--------|--------|--------|--------|
| **DMAC1** | 0x6000_0000 | 6 | PD_LOGIC |
| **DMAC2** | 0x0108_0000 | 2 | PD_HIGH |

### DMAC2 通道寄存器

| 寄存器 | 通道0 | 通道1 | 说明 |
|--------|-------|-------|------|
| SARx | 0x0108_0000 | 0x0108_0058 | 源地址 |
| DARx | 0x0108_0008 | 0x0108_0060 | 目标地址 |
| LLPx | 0x0108_0010 | 0x0108_0068 | 链表指针 |
| CTLx | 0x0108_0018 | 0x0108_0070 | 控制寄存器 |

---

## LLI (Linked List Item) 结构

### Mode B LLI (16 字节)

基于 TRM 和固件分析，确认使用 **相关问题ode B** (不含源状态写回)：

```
+0x00: SARx  (4 字节) - 源地址寄存器
+0x04: DARx  (4 字节) - 目标地址寄存器
+0x08: LLPx  (4 字节) - 下一个 LLI 地址 (0 表示结束)
+0x0C: CTLx  (4 字节) - 控制寄存器
```

### 固件中的 LLI 表

**基地址**: `0x01084FF0`
**大小**: 1279 个 LLI × 16 字节
**验证**: 0x4FF0 / 16 = 1279 (整数) ✓

```
字符 LLI 地址计算:
  lli_offset = r5 × 16
  lli_addr = 0x01084FF0 + lli_offset
```

### 代码证据

在渲染代码区域找到 **19 条 `lsls rX, r5, #4` 指令**：

```
0x02D594: lsls r1, r5, #4
0x02D70E: lsls r0, r5, #4
0x02D87C: lsls r7, r5, #4
```

---

## DMA 传输流程

### 字体渲染 DMA 传输

```
┌─────────────────────────────────────────────────────────────┐
│ 1. 配置 LLI 表                                             │
├─────────────────────────────────────────────────────────────┤
│ LLI[r5].SAR = HIGHRAM0 字体数据地址                         │
│ LLI[r5].DAR = VOP 缓冲区地址                                │
│ LLI[r5].LLP = 0  (单次传输结束)                             │
│ LLI[r5].CTL = 传输配置 (16位, RGB565, 突发大小)             │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ 2. 配置 DMAC2                                              │
├─────────────────────────────────────────────────────────────┤
│ DMAC2_LLPx = lli_addr                                      │
│ DMAC2_CTLx = 使能位 | LLP_EN                                │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ 3. DMA 自动传输                                             │
├─────────────────────────────────────────────────────────────┤
│ HIGHRAM0 → AHB 总线 → VOP 缓冲区 → LCD 显示                │
└─────────────────────────────────────────────────────────────┘
```

### 地址映射

| 源地址 | 目标地址 | 说明 |
|--------|----------|------|
| HIGHRAM0 (0x01000000+) | VOP 缓冲区 | 字体像素数据 |

---

## 固件代码分析

### 已确认的 DMA 相关代码

| 地址 | 指令 | 功能 |
|------|------|------|
| 0x02ACB8 | `ldr r7, [pc, #0x3c0]` | 加载 LLI 基址 0x01084FF0 |
| 0x02D594 | `lsls r1, r5, #4` | 计算 LLI 偏移 |
| 0x02D70E | `lsls r0, r5, #4` | 计算 LLI 偏移 |

### 地址引用统计

| 地址 | 引用次数 | 说明 |
|------|----------|------|
| 0x01084FF0 | 27 | LLI 表基址 |
| 0x010808F1 | 25 | 另一个 DMA 地址 |
| 0x01080008 | 1 | DAR0 寄存器 (巧合) |

---

## 剩余问题

| 问题 | 优先级 | 状态 |
|------|--------|------|
| DMAC 配置代码位置 | 🔴 高 | ⚠️ 找到地址引用 |
| LLI 初始化代码 | 🟡 中 | ❌ 未找到 |
| VOP 缓冲区地址 | 🔴 高 | ❓ 未知 |

---

## 参见

- [TRM 寄存器列表](../01_OVERVIEW/TRM_REGISTER_LIST.md)
- [显示系统分析](./DISPLAY_SYSTEM.md)
- [METHODOLOGY.md](../01_OVERVIEW/METHODOLOGY.md)
