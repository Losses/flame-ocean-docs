# 显示系统分析

**芯片**: Rockchip RKnano
**分析来源**: RKNanoD TRM Chapter 15 + 固件代码分析
**状态**: 已确认

---

## VOP (Video Output Processor) 概述

### VOP 寄存器

| 寄存器 | 地址 | 说明 |
|--------|------|------|
| **VOP_MCU_CON** | 0x6000_0000 | 模式控制寄存器 |
| **VOP_MCU_CMD** | 0x6000_0028 | 命令/索引读写入口 |
| **VOP_MCU_DATA** | 0x6000_002C | 数据读写入口 |

### VOP_MCU_CON 控制位

| Bit | 字段 | 值 | 功能 |
|-----|------|-----|------|
| 8 | sw_mcu_input_format | 0/1 | 0: RGB565, 1: YUV420 |
| **5** | **sw_mcu_byte_swap** | **0/1** | **相关问题CU 写入数据半字交换** |
| **4** | **sw_mcu_hw_swap** | **0/1** | **相关问题CU 写入数据半字交换** |
| **3** | **sw_mcu_bits** | **0/1** | **0: 8位, 1: 16位** |

**确认**: 使用 **16位 RGB565** 格式

---

## revsh 指令确认

### 固件代码

```assembly
0x2DB0A: revsh r1, r6      ; Reverse half-word with sign extension
0x2DB2A: revsh r1, r6      ; Reverse half-word with sign extension
```

### 功能说明

**revsh** 指令用于准备数据给 VOP 的字节交换机制：

```
revsh 指令:
  输入: 0x1234
  输出: 0x3412 (交换后进行符号扩展)

对应 VOP 配置:
  sw_mcu_byte_swap = 1 (位 5)
  sw_mcu_hw_swap = 1 (位 4)
```

**结论**: revsh 指令确认用于 VOP 字节交换 ✓

---

## 显示渲染流程

### 完整流程图

```
┌─────────────────────────────────────────────────────────────┐
│ 阶段 1: Unicode → r5 转换                                   │
├─────────────────────────────────────────────────────────────┤
│ 输入: UTF-16 字符 (r7)                                      │
│ 输出: r5 (字符内部索引)                                     │
│ 状态: ❌ 转换代码未找到                                      │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ 阶段 2: 查找表索引                                          │
├─────────────────────────────────────────────────────────────┤
│ lookup_index = r5 >> 5                                      │
│ 函数指针 = lookup_table[lookup_index]                      │
│ 状态: ✅ 已确认 (0x080000 查找表)                           │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ 阶段 3: 像素数据加载                                        │
├─────────────────────────────────────────────────────────────┤
│ 0x2DB58: ldrh r2, [r6, #6]  ; 从 r6+6 加载像素数据          │
│ 状态: ✅ 已确认                                             │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ 阶段 4: DMA 传输到 VOP                                      │
├─────────────────────────────────────────────────────────────┤
│ DMAC2 从 HIGHRAM0 传输字体数据到 VOP 缓冲区                  │
│ 状态: ⚠️ 部分确认                                           │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│ 阶段 5: VOP 渲染到 LCD                                      │
├─────────────────────────────────────────────────────────────┤
│ VOP 从缓冲区读取像素 → MCU-LCD 接口 → LCD 显示              │
│ 格式: 16位 RGB565                                          │
│ 字节交换: revsh 指令确认                                   │
│ 状态: ✅ 已确认                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 固件代码分析

### 像素加载点

```assembly
0x2DB58: ldrh r2, [r6, #6]    ; 从 r6+6 加载像素数据
0x2DB0A: revsh r1, r6         ; 字节交换
0x2DB2A: revsh r1, r6         ; 字节交换
```

### r6 计算路径

```assembly
0x2DAE8: lsls r1, r4, #5      ; r1 = r4 × 32 (符号表)
0x02DB74: lsls r4, r5, #5     ; r4 = r5 × 32
```

---

## 数据存储

### HIGHRAM0 字体数据

| 项目 | 值 |
|------|-----|
| 地址 | 0x0100_0000 |
| 大小 | 128 KB |
| 用途 | 字体像素数据 |
| 引用次数 | 3283 |

### 地址计算公式

```
像素数据地址 = 0x100000 + r5 × 4
```

---

## 参见

- [TRM 寄存器列表](../01_OVERVIEW/TRM_REGISTER_LIST.md)
- [DMA 架构分析](./DMA_ARCHITECTURE.md)
- [METHODOLOGY.md](../01_OVERVIEW/METHODOLOGY.md)
