# 栈帧传递机制分析

**状态**: ✅ 已确认
**验证日期**: 2026-01-30

---

## 问题陈述

在 0x02DDDC 调度器函数中，r4 寄存器预先包含 `Base + Index` 值。需要追踪：
1. r4 如何被传递到 0x02DDDC
2. 栈帧结构是什么
3. 写入点和读取点的关系

---

## 代码证据

### 写入点（调用者）

```assembly
0x02D212: str r4, [sp, #0x3e4]  ; 将 r4 存储到栈偏移 0x3E4
```

**分析**:
- r4 包含预先计算的 `Base + Index` 值
- 存储位置: 栈帧偏移 0x3E4
- 这是写入点

### 读取点（0x02DDDC 函数）

```assembly
0x02D95E: ldr r4, [sp, #0x3f8]  ; 从栈偏移 0x3F8 恢复 r4
```

**分析**:
- r4 从栈帧恢复
- 读取位置: 栈帧偏移 0x3F8
- 这是读取点

### 偏移差异

```
读取偏移 - 写入偏移 = 0x3F8 - 0x3E4 = 0x14 = 20 字节
```

---

## 栈帧结构分析

### PUSH 指令发现

在 0x02D212 附近发现 7 寄存器 PUSH：
```assembly
push {r3, r4, r5, r6, r7, lr}  ; 6 个寄存器 + lr = 7 个
```

**栈帧大小**: 7 × 4 字节 = 28 字节

### 栈帧布局推测

```
+0x3E4:  r4 (写入点)
+0x3E8:  [其他数据]
+0x3EC:  [其他数据]
+0x3F0:  [其他数据]
+0x3F4:  [其他数据]
+0x3F8:  r4 (读取点) ← 注意：读取点比写入点高 20 字节
```

### 偏移差异解释

0x14 = 20 字节的差异可能由以下原因造成：

1. **多层函数调用**:
   - 调用者函数和被调用函数有不同的栈帧
   - 中间可能有其他函数调用
   - 栈帧在调用链中增长

2. **栈帧对齐**:
   - ARM ABI 要求栈帧 8 字节对齐
   - 可能有填充字节

3. **局部变量**:
   - 0x3E4 到 0x3F8 之间可能存储局部变量

---

## 数据流追踪

### 完整流程

```
[调用者]
  1. 计算 r4 = Base + Index
  2. str r4, [sp, #0x3e4]    ← 写入
  3. bl 0x02DDDC             ← 调用调度器

[调度器 0x02DDDC]
  4. push {..., lr}          ← 保存返回地址
  5. ldr r4, [sp, #0x3f8]    ← 读取 r4
  6. lsls r0, r5, #5         ; r0 = r5 × 32
  7. adds r0, r4, r0         ; r0 = r4 + r0 = Base + Index × 33
```

### 关键发现

1. **r4 预先计算**: 在调用 0x02DDDC 之前，r4 已经是 `Base + Index`
2. **栈传递**: 通过栈帧传递 r4 值
3. **×33 计算**: 在 0x02DDDC 中完成 `r4 + (r5 << 5)`

---

## 验证方法

### 代码搜索

使用 Capstone 反汇编引擎搜索：
- `str r4, [sp, #offset]` 模式
- `ldr r4, [sp, #offset]` 模式
- 匹配 0x3E4 和 0x3F8 偏移

### 结果

| 指令 | 地址 | 偏移 | 功能 |
|------|------|------|------|
| str r4 | 0x02D212 | 0x3E4 | 写入 r4 |
| ldr r4 | 0x02D95E | 0x3F8 | 读取 r4 |

---

## 结论

| 项目 | 状态 |
|------|------|
| 写入点确认 | ✅ 0x02D212 |
| 读取点确认 | ✅ 0x02D95E |
| 偏移差异 | ✅ 0x14 = 20 字节 |
| 栈帧结构 | ⚠️ 复杂，多层调用 |
| 数据流验证 | ✅ 完整追踪 |

---

## 相关文档

- [×33 计算验证](../01_OVERVIEW/MATH_X33_VERIFICATION.md)
- [R6 像素数据指针](./REGISTERS/R6_PIXEL_DATA_POINTER.md)
- [执行摘要](../01_OVERVIEW/EXECUTIVE_SUMMARY.md)
