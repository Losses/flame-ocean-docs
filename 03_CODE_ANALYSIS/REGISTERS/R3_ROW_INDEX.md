# R3 寄存器 - 行索引与偏移量

**状态**: ✅ 已记录
**最后更新**: 2026-01-29

---

## 寄存器用途

**r3** 主要用途：
1. **行索引** - 标识当前处理的像素行
2. **内存偏移量** - 用于像素数据的基址偏移
3. **函数参数** - 作为 0x13365E 函数的第二个参数

---

## 函数参数角色

### 0x13365E 函数签名

```c
fcn.0013365e (int16_t arg3, int16_t arg4, int16_t arg_3ach);
    `- args(r2, r3, sp[0x3ac..0x3ac])
```

**参数说明**:
- `arg3` (r2): int16_t - 可能是 X 坐标或行号
- `arg4` (r3): int16_t - **可能是 Y 坐标或列号**
- `arg_3ach`: 栈上的局部变量

---

## 行索引操作

### 关键代码序列

```assembly
0x0013365A:  ldrsb  r0, [r7, r3]   ; 从 r7+r3 加载符号扩展字节
0x0013365C:  lsls  r3, r3, #0x10  ; 16-bit shift (行计数!)
0x0013365E:  ldrh  r0, [r7, r3]   ; Load half-word (pixel data!)
0x00133660:  lsls  r1, r5, #0x10  ; 16-bit shift (16 rows!)
0x00133662:  lsrs  r0, r3, #2     ; 右移 2 位
0x00133664:  strh  r3, [r7, #0xe]  ; 存储像素行
```

### 操作分析

| 指令 | 操作 | 说明 |
|------|------|------|
| `ldrsb r0, [r7, r3]` | 从 r7+r3 加载字节 | r3 作为偏移量 |
| `lsls r3, r3, #0x10` | r3 = r3 << 16 | 16 位行计数 |
| `ldrh r0, [r7, r3]` | 从 r7+r3 加载半字 | r3 作为行偏移 |
| `lsrs r0, r3, #2` | r0 = r3 >> 2 | 右移 2 位 |
| `strh r3, [r7, #0xe]` | 存储 r3 到 r7+0xe | 保存处理后的行 |

---

## 渲染上下文加载

### 0x2DA8E: ldm 指令

```assembly
0x0002DA8E:  ldm    r1!, {r3, r4, r5, r6, r7}
```

**操作**: 从 r1 指向的渲染上下文加载多个寄存器
- r3: 从 [r1] 加载
- r4: 从 [r1+4] 加载
- r5: 从 [r1+8] 加载 (字符内部索引)
- r6: 从 [r1+12] 加载
- r7: 从 [r1+16] 加载

---

## r3 值的生命周期

```
┌─────────────────────────────────────────────────────────────┐
│ 阶段 1: 函数入口                                            │
├─────────────────────────────────────────────────────────────┤
│ r3 作为函数参数传入                                          │
│ 可能代表 Y 坐标或列号                                        │
└─────────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────────┐
│ 阶段 2: 渲染上下文加载 (0x2DA8E)                            │
├─────────────────────────────────────────────────────────────┤
│ ldm r1!, {r3, r4, r5, r6, r7}                               │
│ r3 从渲染上下文加载                                          │
└─────────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────────┐
│ 阶段 3: 行索引处理                                          │
├─────────────────────────────────────────────────────────────┤
│ ldrsb r0, [r7, r3]   ; 加载符号字节                          │
│ lsls r3, r3, #0x10   ; 16 位左移                             │
│ ldrh r0, [r7, r3]    ; 加载像素数据                          │
└─────────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────────┐
│ 阶段 4: 数据存储                                            │
├─────────────────────────────────────────────────────────────┤
│ strh r3, [r7, #0xe]  ; 存储到渲染上下文                      │
└─────────────────────────────────────────────────────────────┘
```

---

## 未解问题

r3 寄存器的详细问题已汇总到 **[REMAINING_WORK.md](../../01_OVERVIEW/REMAINING_WORK.md)** 阶段 4.2。

**关键问题**:
- r3 的初始值和含义
- `lsls r3, r3, #0x10` 的目的（左移 16 位）
- `strh r3, [r7, #0xe]` 存储位置的作用

---

## 研究状态

| 任务 | 状态 | 说明 |
|------|------|------|
| 行索引操作 | ✅ 完成 | 已确认所有相关指令 |
| 函数参数角色 | ⚠️ 部分 | 知道是参数，但不知具体值 |
| 移位操作目的 | ❓ 未知 | 左移 16 位、右移 2 位的意义 |
| 存储位置用途 | ❓ 未知 | r7+0xe 的作用 |

---

## 相关文档

- [指令级追踪](../INSTRUCTION_TRACE.md)
- [R2 函数参数](./R2_PARAMETER.md)
- [0x13365E 函数分析](../FUNCTION_0x13365E.md)
- [内联渲染逻辑](../INLINE_RENDERING.md)
- [寄存器参考](../../02_ARCHITECTURE/REGISTER_REFERENCE.md)
