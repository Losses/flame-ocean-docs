# 特殊编码路径验证 (2026-01-29)

**验证日期**: 2026-01-29
**验证方法**: Capstone 反汇编 + 数据流追踪
**状态**: ✅ 代码路径已确认，查找表基地址未知

---

## 执行摘要

通过独立验证，确认了固件中存在两种字符编码路径：

1. **标准编码** (15列): 使用公式计算的像素地址
2. **特殊编码** (14列): 使用查找表获取元数据

两种编码路径的代码入口点和分支逻辑已完全验证。

---

## 编码类型判定机制

### 代码位置

```assembly
0x02DB10: lsls r0, r4, #4    ; r0 = r4 << 4
0x02DB12: cmp  r0, #0x80     ; 比较 r0 与 0x80
0x02DB2C: bne  #0x2db4e      ; 如果 r0 != 0x80, 分支到特殊编码
```

### 判定逻辑

| r4 值 | 条件 | 编码类型 | 路径 |
|-------|------|----------|------|
| 0x08 | r4 == 0x08 | 标准编码 (15列) | Fall-through |
| 其他 | r4 != 0x08 | 特殊编码 (14列) | Branch to 0x02DB4E |

**验证方法**: Capstone 反汇编 ✅

---

## 标准编码路径 (15列)

### 代码流程

```
[编码判定] → r4 == 0x08 → [Fall through] → 0x02DB58
```

### 关键指令

```assembly
0x02DB58: ldrh r2, [r6, #6]    ; 从 [r6 + 6] 加载像素数据
```

### 像素地址公式

```
r5 = Unicode >> 2                    ; @ 0x02D4E6
pixel_ptr = 0x100000 + r5 * 4        ; 标准编码公式
```

### 验证示例

**测试字符**: 沨 (U+6CA8)
- r5 = 0x6CA8 >> 2 = 0x1B2A
- pixel_ptr = 0x100000 + 0x1B2A * 4 = 0x106CA8
- 数据 @ 0x106CA8: 80fb9802
- 像素数据指针: 0x0298FB80

**验证状态**: ✅ 公式已验证

---

## 特殊编码路径 (14列)

### 代码流程

```
[编码判定] → r4 != 0x08 → 0x02DB2C → 0x02DB4E → 0x02DC22
```

### 关键指令

```assembly
0x02DB4E: b     #0x2dc22           ; 跳转到特殊编码处理器
0x02DC22: adds  r0, #0xb5          ; r0 += 0xB5
0x02DC2C: lsls  r0, r5, #1         ; r0 = r5 * 2
0x02DC3E: ldr   r6, [r0, #0x14]    ; r6 = [r0 + 0x14]
```

### 查找公式

```
r5 = Unicode >> 2                           ; @ 0x02D4E6
r0 = r5 * 2 = (Unicode >> 2) * 2            ; @ 0x02DC2C
metadata_ptr = [base + r0 + 0x14]           ; @ 0x02DC3E
             = [base + (Unicode >> 2) * 2 + 0x14]
```

### 示例计算

**测试字符**: 沨 (U+6CA8) - 假设使用特殊编码
- r5 = 0x6CA8 >> 2 = 0x1B2A
- lookup_index = r5 * 2 + 0x14 = 0x3668
- metadata_ptr = [base + 0x3668]

**验证状态**: ⚠️ 公式已验证，但 **base 地址未知**

---

## 完整控制流图

```
                Unicode 输入 (r7)
                       ↓
          0x02D4E6: asrs r5, r7, #2
                       ↓
                    r5 = U >> 2
                       ↓
          ┌──────────────────────────┐
          │  编码类型判定              │
          │  0x02DB10-0x02DB2C        │
          └──────────────────────────┘
                       ↓
          ┌──────────┴──────────┐
          ↓                     ↓
    ┌──────────┐         ┌──────────┐
    │ r4==0x08 │         │ r4!=0x08 │
    │(标准编码)│         │(特殊编码)│
    └──────────┘         └──────────┘
          ↓                     ↓
    [Fall through]       [Branch]
          ↓                     ↓
    ┌──────────┐         ┌──────────┐
    │0x02DB58: │         │0x02DB4E: │
    │ldrh r2,  │         │b #0x2dc22│
    │[r6, #6]  │         └──────────┘
    └──────────┘                ↓
          ↓              ┌──────────┐
    pixel_ptr =          │0x02DC22: │
    0x100000 +           │adds r0,  │
    r5 * 4               │#0xb5     │
                          └──────────┘
                                 ↓
                          ┌──────────┐
                          │0x02DC3E: │
                          │ldr r6,   │
                          │[r0, #0x14]│
                          └──────────┘
                                 ↓
                          metadata_ptr =
                          [base +
                           r5 * 2 +
                           0x14]
```

---

## 验证状态总结

### ✅ 已验证

| 项目 | 状态 | 验证方法 |
|------|------|----------|
| Unicode → r5 映射 | ✅ | Capstone @ 0x02D4E6 |
| 编码判定逻辑 | ✅ | Capstone @ 0x02DB2C |
| 标准编码公式 | ✅ | 数据验证 |
| 特殊编码入口 | ✅ | Capstone @ 0x02DB4E |
| 特殊编码查找公式 | ✅ | Capstone @ 0x02DC3E |

### ❓ 未解决

| 问题 | 优先级 | 说明 |
|------|--------|------|
| 特殊编码查找表基地址 | 🔴 高 | base 值未知 |
| r4 值的确定机制 | 🔴 高 | r4 初始值来源未知 |
| 特殊编码元数据格式 | 🟡 中 | 需要先找到查找表 |

---

## 下一步研究方向

### 优先级 1: 找到特殊编码查找表基地址

**方法**:
1. 追踪 0x02DC22 入口点的 r0 来源
2. 搜索符合 `[base + (U >> 2) * 2 + 0x14]` 公式结构的数据表
3. 分析函数调用链以确定 r0 参数

### 优先级 2: 理解 r4 值的确定机制

**方法**:
1. 从函数入口追踪 r4 的设置
2. 分析 r4 与 Unicode 字符的关系
3. 确定哪些字符使用标准编码 vs 特殊编码

### 优先级 3: 分析特殊编码元数据结构

**前提**: 需要先找到查找表

**方法**:
1. 提取查找表数据
2. 分析元数据格式
3. 对比 14列 vs 15列 编码的差异

---

## 相关文档

- [独立验证结果](../01_OVERVIEW/SOLUTION_VERIFICATION_2026-01-29.md)
- [数据流追踪总结](./DATA_FLOW_SUMMARY.md)
- [未解决问题](../01_OVERVIEW/EXECUTIVE_SUMMARY.md)
