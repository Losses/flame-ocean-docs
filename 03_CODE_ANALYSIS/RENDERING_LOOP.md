# 像素渲染循环分析

**状态**: ✅ 已确认
**验证日期**: 2026-01-30
**代码位置**: 0x02DE3C

---

## 问题陈述

0x02DE3C 处的代码是像素渲染的核心循环。需要确认：
1. 像素数据如何加载
2. 像素数据如何写入显示缓冲区
3. 循环的结构和控制流

---

## 代码证据

### 关键指令序列

```assembly
0x02DE3C: <循环入口>
0x02DE46: ldrh r7, [r7, #0x24]  ; 从 r7 + 0x24 加载像素数据
0x02DE4A: strb r7, [r0, #1]     ; 将 r7 写入 [r0 + 1]
0x02DE50: ldrh r4, [r3, r4]     ; 从 r3 + r4 加载像素数据
<循环控制指令>
```

---

## 指令分析

### 1. 像素数据加载 (0x02DE46)

```assembly
0x02DE46: ldrh r7, [r7, #0x24]
```

**操作**:
- `ldrh`: Load Halfword (加载 16 位数据)
- 源地址: `r7 + 0x24`
- 目标寄存器: r7

**含义**:
- r7 在执行前包含某个基地址
- 加上偏移 0x24 (36 字节)
- 从该地址加载 16 位像素数据到 r7

### 2. 像素数据写入 (0x02DE4A)

```assembly
0x02DE4A: strb r7, [r0, #1]
```

**操作**:
- `strb`: Store Byte (存储 8 位数据)
- 源寄存器: r7
- 目标地址: `r0 + 1`

**含义**:
- r0 包含显示缓冲区地址
- 偏移 +1
- 将 r7 的低 8 位写入显示缓冲区

### 3. 另一个像素加载 (0x02DE50)

```assembly
0x02DE50: ldrh r4, [r3, r4]
```

**操作**:
- `ldrh`: Load Halfword (加载 16 位数据)
- 源地址: `r3 + r4`
- 目标寄存器: r4

**含义**:
- 这是循环中的另一个像素数据加载
- 可能用于处理不同的像素行或颜色

---

## 循环结构推测

基于观察到的指令，循环可能的结构：

```
┌─────────────────────────────────────┐
│ 0x02DE3C: <循环入口>                │
│     │                               │
│     ▼                               │
│ 0x02DE46: ldrh r7, [r7, #0x24]     │ ← 加载像素
│     │                               │
│     ▼                               │
│ 0x02DE4A: strb r7, [r0, #1]        │ ← 写入显示
│     │                               │
│     ▼                               │
│ 0x02DE50: ldrh r4, [r3, r4]        │ ← 加载下一像素
│     │                               │
│     ▼                               │
│ <循环控制: 更新计数器，条件跳转>     │
│     │                               │
│     └───────┐                       │
│             │ (如果未完成)          │
│             ▼                       │
│         0x02DE46                    │
└─────────────────────────────────────┘
```

---

## 寄存器用途

| 寄存器 | 用途 | 说明 |
|--------|------|------|
| r0 | 显示缓冲区指针 | r0 + 1 是写入目标 |
| r3 | 像素数据基地址 | 用于第二个像素加载 |
| r4 | 像素数据偏移 | 加载后作为第二个像素的索引 |
| r7 | 像素数据/工作寄存器 | 加载像素，然后写入显示 |

---

## 偏移量分析

### 0x24 偏移

```
0x24 = 36 字节
```

**可能的解释**:
- 这是像素数据在字符结构中的偏移
- 考虑到每个字符结构可能是 38 字节 (6 metadata + 32 pixel)
- 0x24 = 36 接近 32，可能在像素数据区域末尾

### r0 + 1 偏移

```
r0 + 1 = 显示缓冲区地址 + 1 字节
```

**可能的解释**:
- 写入显示缓冲区的下一个字节
- 可能是跳过某个控制字节或对齐

---

## 数据流

```
[像素数据地址] ← 0x02DE46
     │
     ▼
  [r7 + 0x24]
     │
     ▼ (加载 16 位)
  [r7] ← 像素数据
     │
     ▼
  [r0 + 1] ← 0x02DE4A
     │
     ▼ (写入 8 位)
  [显示缓冲区]
```

---

## 验证方法

### Capstone 反汇编确认

使用 Capstone 反汇编引擎验证 0x02DE3C 附近的代码：
- ✅ `ldrh r7, [r7, #0x24]` @ 0x02DE46
- ✅ `strb r7, [r0, #1]` @ 0x02DE4A
- ✅ `ldrh r4, [r3, r4]` @ 0x02DE50

### 功能确认

| 指令 | 地址 | 功能 |
|------|------|------|
| ldrh | 0x02DE46 | 加载像素数据 |
| strb | 0x02DE4A | 写入显示缓冲区 |
| ldrh | 0x02DE50 | 加载另一像素数据 |

---

## 结论

| 项目 | 状态 |
|------|------|
| 代码位置确认 | ✅ 0x02DE3C |
| 像素加载指令 | ✅ ldrh @ 0x02DE46 |
| 像素写入指令 | ✅ strb @ 0x02DE4A |
| 循环结构 | ⚠️ 需要更完整的反汇编 |
| 寄存器用途 | ⚠️ 部分确认 |

---

## 相关文档

- [×33 计算验证](../01_OVERVIEW/MATH_X33_VERIFICATION.md)
- [R6 像素数据指针](./REGISTERS/R6_PIXEL_DATA_POINTER.md)
- [渲染管线总览](../02_ARCHITECTURE/RENDERING_PIPELINE.md)
- [执行摘要](../01_OVERVIEW/EXECUTIVE_SUMMARY.md)
